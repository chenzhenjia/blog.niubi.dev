<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>使用kubespray部署kubernetes集群 - 陈</title><meta name=Description content="陈"><meta property="og:title" content="使用kubespray部署kubernetes集群"><meta property="og:description" content="准备工作 因为是部署集群，所以需要两台机器，(我使用的是digitalocean这个云提供商) 内存至少1.5GB 以上，不然会安装失败。 需要每一台机器都能 ping 通 我的一些配置 系统为 centos7 节点的信息 这里使用digitalocean提供的内网地址 准备安装 修改主节点的 hosts 文件，把节点ip 和名字写进去 vi /etc/hosts
10.132.37.154 master 10.132.45.167 node1 所有节点无密码登录
生成无密码的密钥对，用来进行主节点到副节点之间的无密码登录。 直接全都回车，生成的密钥对在 ~/.ssh 目录下面，默认名称为 id_rsa和id_rsa.pub ssh-keygen 把公钥分别写到主节点和副节点的~/.ssh/authorized_keys 文件中。 注意：每个节点都有添加这个公钥，不管是本机还是其他机器 # 先查看 id_rsa.pub 内容，复制出来，贴贴到 authorized_keys文件的最末尾 cat ~/.ssh/id_rsa.pub # 贴到末尾 vi ~/.ssh/authorized_keys 在主节点安装pip
centos 安装 easy_install pip ubuntu 安装 apt-get update -y apt-get install python python-pip centos 需要安装 git
yum -y install git 使用 pip 安装 ansible 和 kubespray"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.niubi.dev/posts/%E4%BD%BF%E7%94%A8kubespray%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-11-28T10:43:40+08:00"><meta property="article:modified_time" content="2017-11-28T10:43:40+08:00"><meta property="og:site_name" content="陈"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用kubespray部署kubernetes集群"><meta name=twitter:description content="准备工作 因为是部署集群，所以需要两台机器，(我使用的是digitalocean这个云提供商) 内存至少1.5GB 以上，不然会安装失败。 需要每一台机器都能 ping 通 我的一些配置 系统为 centos7 节点的信息 这里使用digitalocean提供的内网地址 准备安装 修改主节点的 hosts 文件，把节点ip 和名字写进去 vi /etc/hosts
10.132.37.154 master 10.132.45.167 node1 所有节点无密码登录
生成无密码的密钥对，用来进行主节点到副节点之间的无密码登录。 直接全都回车，生成的密钥对在 ~/.ssh 目录下面，默认名称为 id_rsa和id_rsa.pub ssh-keygen 把公钥分别写到主节点和副节点的~/.ssh/authorized_keys 文件中。 注意：每个节点都有添加这个公钥，不管是本机还是其他机器 # 先查看 id_rsa.pub 内容，复制出来，贴贴到 authorized_keys文件的最末尾 cat ~/.ssh/id_rsa.pub # 贴到末尾 vi ~/.ssh/authorized_keys 在主节点安装pip
centos 安装 easy_install pip ubuntu 安装 apt-get update -y apt-get install python python-pip centos 需要安装 git
yum -y install git 使用 pip 安装 ansible 和 kubespray"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.niubi.dev/posts/%E4%BD%BF%E7%94%A8kubespray%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/><link rel=prev href=https://blog.niubi.dev/posts/liquibase-%E8%B8%A9%E5%9D%91%E8%AE%B0/><link rel=next href=https://blog.niubi.dev/posts/springsecurity%E9%85%8D%E7%BD%AEignoring%E4%B8%8D%E7%94%9F%E6%95%88%E7%9A%84%E9%97%AE%E9%A2%98/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"使用kubespray部署kubernetes集群","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.niubi.dev\/posts\/%E4%BD%BF%E7%94%A8kubespray%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4\/"},"genre":"posts","wordcount":221,"url":"https:\/\/blog.niubi.dev\/posts\/%E4%BD%BF%E7%94%A8kubespray%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4\/","datePublished":"2017-11-28T10:43:40+08:00","dateModified":"2017-11-28T10:43:40+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"陈"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=陈>陈</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=陈>陈</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">使用kubespray部署kubernetes集群</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>陈</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2017-11-28>2017-11-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 221 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 2 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#准备工作>准备工作</a></li><li><a href=#我的一些配置>我的一些配置</a></li><li><a href=#准备安装>准备安装</a></li><li><a href=#增加节点>增加节点</a></li></ul></nav></div></div><div class=content id=content><h2 id=准备工作>准备工作</h2><ol><li>因为是部署集群，所以需要两台机器，(我使用的是digitalocean这个云提供商)</li><li>内存至少1.5GB 以上，不然会安装失败。</li><li>需要每一台机器都能 ping 通</li></ol><h2 id=我的一些配置>我的一些配置</h2><ol><li>系统为 centos7</li><li>节点的信息
<em>这里使用digitalocean提供的内网地址</em></li></ol><h2 id=准备安装>准备安装</h2><ol><li><p>修改主节点的 hosts 文件，把节点ip 和名字写进去
<code>vi /etc/hosts</code></p><pre tabindex=0><code>10.132.37.154 master
10.132.45.167 node1
</code></pre></li><li><p>所有节点无密码登录</p><ol><li>生成无密码的密钥对，用来进行主节点到副节点之间的无密码登录。
直接全都回车，生成的密钥对在 ~/.ssh 目录下面，默认名称为 <code>id_rsa</code>和<code>id_rsa.pub</code><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh-keygen
</span></span></code></pre></div></li><li>把公钥分别写到主节点和副节点的<code>~/.ssh/authorized_keys</code> 文件中。
<em>注意：每个节点都有添加这个公钥，不管是本机还是其他机器</em></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 先查看 id_rsa.pub 内容，复制出来，贴贴到 authorized_keys文件的最末尾</span>
</span></span><span class=line><span class=cl>cat ~/.ssh/id_rsa.pub
</span></span><span class=line><span class=cl><span class=c1># 贴到末尾</span>
</span></span><span class=line><span class=cl>vi ~/.ssh/authorized_keys
</span></span></code></pre></div></li><li><p>在主节点安装pip</p><ol><li>centos 安装
<code>easy_install pip</code></li><li>ubuntu 安装<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apt-get update -y
</span></span><span class=line><span class=cl>apt-get install python python-pip
</span></span></code></pre></div></li></ol></li><li><p>centos 需要安装 <code>git</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum -y install git
</span></span></code></pre></div></li><li><p>使用 pip 安装 ansible 和 kubespray</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install ansible kubespray
</span></span></code></pre></div></li><li><p>修改所有节点的 <code>/etc/resolv.conf</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;nameserver 8.8.8.8&#34;</span> <span class=p>|</span> sudo tee /etc/resolv.conf
</span></span></code></pre></div></li><li><p>添加 kubespray 的配置文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; ~/.kubespray.yml
</span></span></span><span class=line><span class=cl><span class=s>kubespray_git_repo: &#34;https://github.com/kubernetes-incubator/kubespray.git&#34;
</span></span></span><span class=line><span class=cl><span class=s># Logging options
</span></span></span><span class=line><span class=cl><span class=s>loglevel: &#34;info&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div></li><li><p>用 kubespray 生成节点的配置文件
会在 <code>~/</code> 目录下生成一个 <code>.kubespray</code> 文件夹</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubespray prepare --masters master --etcds master --nodes node1
</span></span></code></pre></div></li><li><p>编辑 inventory.cfg 文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> .kubespray
</span></span><span class=line><span class=cl>vi inventory/inventory.cfg
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>master ansible_ssh_host=10.132.37.154 ip=10.132.37.154
</span></span><span class=line><span class=cl>node1 ansible_ssh_host=10.132.45.167 ip=10.132.45.167
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[kube-master]
</span></span><span class=line><span class=cl>master
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[all]
</span></span><span class=line><span class=cl>node1
</span></span><span class=line><span class=cl>master
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[k8s-cluster:children]
</span></span><span class=line><span class=cl>kube-node
</span></span><span class=line><span class=cl>kube-master
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[kube-node]
</span></span><span class=line><span class=cl>node1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[etcd]
</span></span><span class=line><span class=cl>master
</span></span></code></pre></div></li><li><p>在 ~/.kubespray 目录下执行部署 k8s 命令。
<em>注意:</em> 在 digitalocean 的 centos7 上会遇到一个 <code>Check_certs | Set 'sync_certs' to true</code> 的错误。解决方法
显示了 <code>Kubernetes deployed successfuly</code> 则部署成功</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/.kubespray
</span></span><span class=line><span class=cl>ansible-playbook -i inventory/inventory.cfg cluster.yml -b -v --private-key<span class=o>=</span>~/.ssh/id_rsa
</span></span></code></pre></div></li><li><p>验证 k8s 集群</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get nodes
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>NAME      STATUS    ROLES     AGE       VERSION
</span></span><span class=line><span class=cl>master    Ready     master    2m        v1.8.3+coreos.0
</span></span><span class=line><span class=cl>node1     Ready     node      2m        v1.8.3+coreos.0
</span></span></code></pre></div></li></ol><h2 id=增加节点>增加节点</h2><ol><li>把新增的节点 ip 配置到 hosts 文件中
<code>vi /etc/hosts</code><pre tabindex=0><code>10.132.37.154 master
10.132.45.167 node1
10.132.45.87  node2
</code></pre></li><li>在 <code>~/.kubespray</code> 目录执行命令
<code>cd ~/.kubespray</code>
<code>ansible-playbook -i inventory/inventory.cfg scale.yml -b -v --private-key=~/.ssh/id_rsa -l node2</code></li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2017-11-28</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/liquibase-%E8%B8%A9%E5%9D%91%E8%AE%B0/ class=prev rel=prev title="liquibase 踩坑记"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>liquibase 踩坑记</a>
<a href=/posts/springsecurity%E9%85%8D%E7%BD%AEignoring%E4%B8%8D%E7%94%9F%E6%95%88%E7%9A%84%E9%97%AE%E9%A2%98/ class=next rel=next title="Spring Security 配置 ignoring 不生效的问题">Spring Security 配置 ignoring 不生效的问题<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5524310624522502" crossorigin=anonymous></script></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>陈</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>